import { PrismaClient } from '@prisma/client';
import { readFileSync } from 'fs';
import { join } from 'path';

const prisma = new PrismaClient();

// V√©rifier si le flag --with-test-data est pr√©sent
const withTestData = process.argv.includes('--with-test-data');

// Donn√©es des zones d'intervention
const ZONES_DATA = [
  {
    slug: 'pare-brise-carouge',
    name: 'Carouge',
    locale: 'fr',
    metaTitle: 'Pare-brise Carouge - Remplacement Express et R√©paration | PareBrise Gen√®ve Pro',
    metaDescription: 'Service de remplacement et r√©paration de pare-brise √† Carouge. Intervention rapide dans tout le quartier, devis gratuit. ‚úì Garantie √† vie ‚úì Prise en charge assurance.',
    coordinates: { lat: 46.1810, lng: 6.1390 },
    featuredImage: '/images/zones/carouge-pare-brise.jpg',
  },
  {
    slug: 'pare-brise-lancy',
    name: 'Lancy',
    locale: 'fr',
    metaTitle: 'Pare-brise Lancy - Service Mobile Grand-Lancy et Petit-Lancy | PareBrise Gen√®ve Pro',
    metaDescription: 'Expert pare-brise √† Lancy : remplacement et r√©paration √† domicile. Intervention rapide Grand-Lancy et Petit-Lancy. ‚úì Sans franchise ‚úì Garantie constructeur.',
    coordinates: { lat: 46.1897, lng: 6.1191 },
    featuredImage: '/images/zones/lancy-pare-brise.jpg',
  },
  {
    slug: 'pare-brise-meyrin',
    name: 'Meyrin',
    locale: 'fr',
    metaTitle: 'Pare-brise Meyrin - R√©paration Express Zone A√©roport | PareBrise Gen√®ve Pro',
    metaDescription: 'Sp√©cialiste pare-brise √† Meyrin et zone a√©roport. Remplacement rapide, calibrage ADAS inclus. Service entreprises disponible. ‚úì Devis imm√©diat ‚úì 7j/7.',
    coordinates: { lat: 46.2340, lng: 6.0810 },
    featuredImage: '/images/zones/meyrin-pare-brise.jpg',
  },
  {
    slug: 'pare-brise-vernier',
    name: 'Vernier',
    locale: 'fr',
    metaTitle: 'Pare-brise Vernier - Intervention Rapide Zone Industrielle | PareBrise Gen√®ve Pro',
    metaDescription: 'Remplacement pare-brise √† Vernier. Service mobile dans les zones industrielles et r√©sidentielles. Techniciens certifi√©s, prix transparents.',
    coordinates: { lat: 46.2170, lng: 6.0840 },
    featuredImage: '/images/zones/vernier-pare-brise.jpg',
  },
];

// Donn√©es FAQ globales
const FAQ_DATA = [
  {
    question: 'Combien co√ªte le remplacement d\'un pare-brise ?',
    answer: 'Le prix d√©pend du mod√®le de votre v√©hicule et des options (capteurs ADAS, pare-brise chauffant). Nos tarifs commencent √† 350 CHF pour une citadine standard. Utilisez notre calculateur en ligne pour obtenir un prix exact en 30 secondes.',
    category: 'pricing',
    locale: 'fr',
    order: 1,
  },
  {
    question: 'Ma franchise d\'assurance sera-t-elle appliqu√©e ?',
    answer: 'Pour les r√©parations d\'impacts (√©clats, fissures de moins de 10cm), la plupart des assurances suisses ne demandent pas de franchise. Pour un remplacement complet, la franchise d√©pend de votre contrat. Nous g√©rons directement les d√©marches avec votre assurance.',
    category: 'insurance',
    locale: 'fr',
    order: 2,
  },
  {
    question: 'Combien de temps dure l\'intervention ?',
    answer: 'Une r√©paration d\'impact prend environ 30 minutes. Un remplacement complet n√©cessite 2 heures, incluant le temps de s√©chage. Si votre v√©hicule a des capteurs ADAS, comptez 45 minutes suppl√©mentaires pour le calibrage.',
    category: 'service',
    locale: 'fr',
    order: 3,
  },
  {
    question: 'Puis-je conduire imm√©diatement apr√®s le remplacement ?',
    answer: 'Oui, vous pouvez reprendre la route imm√©diatement. Nous utilisons des colles haute performance qui polym√©risent rapidement. Nous recommandons simplement d\'√©viter les lavages haute pression pendant 24h.',
    category: 'service',
    locale: 'fr',
    order: 4,
  },
  {
    question: 'Quelle est la garantie sur vos interventions ?',
    answer: 'Nous offrons une garantie √† vie sur les remplacements de pare-brise (√©tanch√©it√© et installation), 2 ans sur les r√©parations, et une certification constructeur pour les calibrages ADAS. La garantie couvre les d√©fauts d\'installation et d\'√©tanch√©it√©.',
    category: 'warranty',
    locale: 'fr',
    order: 5,
  },
];

// Donn√©es des t√©moignages
const TESTIMONIALS_DATA = [
  {
    author: 'Marc Dubois',
    location: 'Eaux-Vives',
    rating: 5,
    date: new Date('2024-01-15'),
    content: 'Service impeccable ! J\'ai appel√© pour un impact sur mon pare-brise, et le technicien est arriv√© dans l\'heure. R√©paration rapide et invisible, prix tr√®s correct. Je recommande vivement PareBrise Gen√®ve Pro.',
    serviceType: 'repair',
    vehicleBrand: 'Audi',
    locale: 'fr',
  },
  {
    author: 'Sophie M√ºller',
    location: 'Champel',
    rating: 5,
    date: new Date('2024-01-20'),
    content: 'Excellente exp√©rience du d√©but √† la fin. Devis en ligne pr√©cis, intervention √† domicile parfaite. Le technicien a m√™me calibr√© mes capteurs ADAS. Tr√®s professionnel !',
    serviceType: 'replacement',
    vehicleBrand: 'Mercedes',
    locale: 'fr',
  },
  {
    author: 'Jean-Pierre Favre',
    location: 'Plainpalais',
    rating: 5,
    date: new Date('2024-01-25'),
    content: 'Suite √† un gros impact, j\'ai d√ª remplacer mon pare-brise en urgence. Intervention le jour m√™me, travail soign√©, et ils ont g√©r√© directement avec mon assurance. Vraiment top !',
    serviceType: 'replacement',
    vehicleBrand: 'Volkswagen',
    locale: 'fr',
  },
];

// Donn√©es de test suppl√©mentaires (activ√©es avec --with-test-data)
const TEST_TESTIMONIALS = [
  {
    author: 'Test User 1',
    location: 'Test Location',
    rating: 4,
    date: new Date(),
    content: 'Ceci est un t√©moignage de test pour le d√©veloppement. Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
    serviceType: 'repair',
    vehicleBrand: 'Toyota',
    locale: 'fr',
    featured: true,
  },
  {
    author: 'Test User 2',
    location: 'Dev Environment',
    rating: 5,
    date: new Date(),
    content: 'Autre t√©moignage fictif pour tester l\'affichage et le tri. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.',
    serviceType: 'replacement',
    vehicleBrand: 'Tesla',
    locale: 'fr',
    featured: true,
  },
];

// Donn√©es des services
const SERVICES_DATA = [
  {
    slug: 'remplacement-pare-brise',
    name: 'Remplacement de Pare-brise',
    shortDescription: 'Remplacement complet avec garantie √† vie',
    icon: 'üöó',
    basePrice: 350,
    locale: 'fr',
    order: 1,
  },
  {
    slug: 'reparation-impact',
    name: 'R√©paration d\'Impact',
    shortDescription: 'R√©paration invisible en 30 minutes',
    icon: 'üîß',
    basePrice: 89,
    locale: 'fr',
    order: 2,
  },
  {
    slug: 'calibrage-adas',
    name: 'Calibrage ADAS',
    shortDescription: 'Recalibrage des syst√®mes d\'aide √† la conduite',
    icon: 'üì°',
    basePrice: 180,
    locale: 'fr',
    order: 3,
  },
  {
    slug: 'renovation-phares',
    name: 'R√©novation de Phares',
    shortDescription: 'Polissage et protection UV',
    icon: 'üí°',
    basePrice: 110,
    locale: 'fr',
    order: 4,
  },
];

async function main() {
  console.log('üå± D√©but du seed de la base de donn√©es...');
  if (withTestData) {
    console.log('üìä Mode test activ√© - ajout de donn√©es fictives');
  }

  // Nettoyer la base de donn√©es
  await prisma.$transaction([
    prisma.testimonial.deleteMany(),
    prisma.faq.deleteMany(),
    prisma.localPage.deleteMany(),
    prisma.service.deleteMany(),
    prisma.stat.deleteMany(),
    prisma.priceConfig.deleteMany(),
  ]);

  console.log('üßπ Base de donn√©es nettoy√©e');

  // Cr√©er les services
  for (const service of SERVICES_DATA) {
    await prisma.service.create({
      data: service,
    });
  }
  console.log('‚úÖ Services cr√©√©s');

  // Cr√©er les zones d'intervention
  for (const zone of ZONES_DATA) {
    // Lire le contenu MDX depuis le fichier
    let content = '';
    try {
      const mdxPath = join(process.cwd(), 'content', 'zones', `${zone.slug}.mdx`);
      const mdxContent = readFileSync(mdxPath, 'utf-8');
      // Extraire le contenu apr√®s le frontmatter
      const contentMatch = mdxContent.match(/---[\s\S]*?---\n([\s\S]*)/);
      content = contentMatch ? contentMatch[1].trim() : '';
    } catch (error) {
      console.warn(`‚ö†Ô∏è Fichier MDX non trouv√© pour ${zone.slug}, utilisation du contenu par d√©faut`);
      content = `# ${zone.name}\n\nContenu √† venir...`;
    }

    await prisma.localPage.create({
      data: {
        ...zone,
        content,
      },
    });
  }
  console.log('‚úÖ Zones d\'intervention cr√©√©es');

  // Cr√©er les FAQ
  for (const faq of FAQ_DATA) {
    await prisma.faq.create({
      data: faq,
    });
  }
  console.log('‚úÖ FAQ cr√©√©es');

  // Cr√©er les t√©moignages
  const testimonialsToCreate = withTestData 
    ? [...TESTIMONIALS_DATA, ...TEST_TESTIMONIALS]
    : TESTIMONIALS_DATA;

  for (const testimonial of testimonialsToCreate) {
    await prisma.testimonial.create({
      data: testimonial,
    });
  }
  console.log(`‚úÖ ${testimonialsToCreate.length} t√©moignages cr√©√©s`);

  // Cr√©er quelques statistiques
  await prisma.stat.create({
    data: {
      key: 'total_interventions',
      value: withTestData ? 99999 : 15420,
      label: 'Interventions r√©alis√©es',
      locale: 'fr',
    },
  });

  await prisma.stat.create({
    data: {
      key: 'average_rating',
      value: 4.9,
      label: 'Note moyenne',
      locale: 'fr',
    },
  });

  await prisma.stat.create({
    data: {
      key: 'response_time',
      value: withTestData ? 15 : 45,
      label: 'Temps de r√©ponse moyen (min)',
      locale: 'fr',
    },
  });

  console.log('‚úÖ Statistiques cr√©√©es');

  // Cr√©er quelques configurations de prix (pour les nouvelles marques)
  if (withTestData) {
    const testPrices = [
      { brand: 'TOYOTA', model: 'yaris', serviceType: 'REPLACEMENT', price: 320 },
      { brand: 'TOYOTA', model: 'yaris', serviceType: 'REPAIR', price: 89 },
      { brand: 'VOLVO', model: 'xc60', serviceType: 'REPLACEMENT', price: 620 },
      { brand: 'VOLVO', model: 'xc60', serviceType: 'REPAIR', price: 89 },
    ];

    for (const priceConfig of testPrices) {
      await prisma.priceConfig.create({
        data: priceConfig,
      });
    }
    console.log('‚úÖ Configurations de prix test cr√©√©es');
  }

  console.log('üéâ Seed termin√© avec succ√®s !');
}

main()
  .catch((e) => {
    console.error('‚ùå Erreur lors du seed :', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  }); 